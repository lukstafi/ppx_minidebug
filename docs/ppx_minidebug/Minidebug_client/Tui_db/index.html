<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Tui_db (ppx_minidebug.Minidebug_client.Tui_db)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 3.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../../index.html">Index</a> &#x00BB; <a href="../../index.html">ppx_minidebug</a> &#x00BB; <a href="../index.html">Minidebug_client</a> &#x00BB; Tui_db</nav><header class="odoc-preamble"><h1>Module <code><span>Minidebug_client.Tui_db</span></code></h1><p>TUI state database persistence module.</p><p>This module provides functions for serializing and deserializing TUI state to/from the SQLite database, enabling DB-backed TUI state for CLI client access.</p><p>The TUI server writes state to DB after each change. CLI clients read state from DB to reconstruct the view. Commands flow through the tui_commands table.</p></header><div class="odoc-content"><div class="odoc-spec"><div class="spec module anchored" id="module-I"><a href="#module-I" class="anchor"></a><code><span><span class="keyword">module</span> I</span><span> = <a href="../Interactive/index.html">Interactive</a></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Q"><a href="#module-Q" class="anchor"></a><code><span><span class="keyword">module</span> Q</span><span> = <a href="../Query/index.html">Query</a></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Json"><a href="#module-Json" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Json/index.html">Json</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>JSON serialization helpers</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-tui_db"><a href="#type-tui_db" class="anchor"></a><code><span><span class="keyword">type</span> tui_db</span><span> = </span><span>{</span></code><ol><li id="type-tui_db.db" class="def record field anchored"><a href="#type-tui_db.db" class="anchor"></a><code><span>db : <span class="xref-unresolved">Sqlite3</span>.db;</span></code></li><li id="type-tui_db.tables_initialized" class="def record field anchored"><a href="#type-tui_db.tables_initialized" class="anchor"></a><code><span><span class="keyword">mutable</span> tables_initialized : bool;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>TUI database state management</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-initialize_tui_tables"><a href="#val-initialize_tui_tables" class="anchor"></a><code><span><span class="keyword">val</span> initialize_tui_tables : <span><span class="xref-unresolved">Sqlite3</span>.db <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Initialize TUI state tables. These tables support DB-backed TUI state for CLI client access.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-create"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : <span>string <span class="arrow">&#45;&gt;</span></span> <a href="#type-tui_db">tui_db</a></span></code></div><div class="spec-doc"><p>Create a TUI database context</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-ensure_tables"><a href="#val-ensure_tables" class="anchor"></a><code><span><span class="keyword">val</span> ensure_tables : <span><a href="#type-tui_db">tui_db</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Ensure TUI tables are initialized</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-close"><a href="#val-close" class="anchor"></a><code><span><span class="keyword">val</span> close : <span><a href="#type-tui_db">tui_db</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Close TUI database connection</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-hashtbl_keys_to_list"><a href="#val-hashtbl_keys_to_list" class="anchor"></a><code><span><span class="keyword">val</span> hashtbl_keys_to_list : <span><span><span>(<span class="type-var">'a</span>, <span class="type-var">'b</span>)</span> <span class="xref-unresolved">Stdlib</span>.Hashtbl.t</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> list</span></span></code></div><div class="spec-doc"><p>Convert Hashtbl keys to list</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-write_state_in_txn"><a href="#val-write_state_in_txn" class="anchor"></a><code><span><span class="keyword">val</span> write_state_in_txn : <span><span class="xref-unresolved">Sqlite3</span>.db <span class="arrow">&#45;&gt;</span></span> <span><a href="../Interactive/index.html#type-view_state">I.view_state</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Internal: Write tui_state fields to database (assumes transaction is active)</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-write_visible_items_in_txn"><a href="#val-write_visible_items_in_txn" class="anchor"></a><code><span><span class="keyword">val</span> write_visible_items_in_txn : <span><span class="xref-unresolved">Sqlite3</span>.db <span class="arrow">&#45;&gt;</span></span> <span><span><a href="../Interactive/index.html#type-visible_item">I.visible_item</a> array</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Internal: Write visible items to database (assumes transaction is active)</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-write_search_results_in_txn"><a href="#val-write_search_results_in_txn" class="anchor"></a><code><span><span class="keyword">val</span> write_search_results_in_txn : <span><span class="xref-unresolved">Sqlite3</span>.db <span class="arrow">&#45;&gt;</span></span> <span><a href="../Interactive/index.html#type-slot_map">I.slot_map</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Internal: Write search slots and results to database (assumes transaction is active)</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-persist_state_atomic"><a href="#val-persist_state_atomic" class="anchor"></a><code><span><span class="keyword">val</span> persist_state_atomic : <span><a href="#type-tui_db">tui_db</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Interactive/index.html#type-view_state">I.view_state</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Write full TUI state atomically in a single transaction. This ensures revision increment and all dependent tables are consistent.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-read_revision"><a href="#val-read_revision" class="anchor"></a><code><span><span class="keyword">val</span> read_revision : <span><a href="#type-tui_db">tui_db</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p>Read current revision number</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-basic_state"><a href="#type-basic_state" class="anchor"></a><code><span><span class="keyword">type</span> basic_state</span><span> = </span><span>{</span></code><ol><li id="type-basic_state.revision" class="def record field anchored"><a href="#type-basic_state.revision" class="anchor"></a><code><span>revision : int;</span></code></li><li id="type-basic_state.cursor" class="def record field anchored"><a href="#type-basic_state.cursor" class="anchor"></a><code><span>cursor : int;</span></code></li><li id="type-basic_state.scroll_offset" class="def record field anchored"><a href="#type-basic_state.scroll_offset" class="anchor"></a><code><span>scroll_offset : int;</span></code></li><li id="type-basic_state.show_times" class="def record field anchored"><a href="#type-basic_state.show_times" class="anchor"></a><code><span>show_times : bool;</span></code></li><li id="type-basic_state.values_first" class="def record field anchored"><a href="#type-basic_state.values_first" class="anchor"></a><code><span>values_first : bool;</span></code></li><li id="type-basic_state.current_slot" class="def record field anchored"><a href="#type-basic_state.current_slot" class="anchor"></a><code><span>current_slot : <a href="../Interactive/SlotNumber/index.html#type-t">I.SlotNumber.t</a>;</span></code></li><li id="type-basic_state.search_order" class="def record field anchored"><a href="#type-basic_state.search_order" class="anchor"></a><code><span>search_order : <a href="../Query/index.html#type-search_order">Q.search_order</a>;</span></code></li><li id="type-basic_state.quiet_path" class="def record field anchored"><a href="#type-basic_state.quiet_path" class="anchor"></a><code><span>quiet_path : <span>string option</span>;</span></code></li><li id="type-basic_state.search_input" class="def record field anchored"><a href="#type-basic_state.search_input" class="anchor"></a><code><span>search_input : <span>string option</span>;</span></code></li><li id="type-basic_state.quiet_path_input" class="def record field anchored"><a href="#type-basic_state.quiet_path_input" class="anchor"></a><code><span>quiet_path_input : <span>string option</span>;</span></code></li><li id="type-basic_state.goto_input" class="def record field anchored"><a href="#type-basic_state.goto_input" class="anchor"></a><code><span>goto_input : <span>string option</span>;</span></code></li><li id="type-basic_state.max_scope_id" class="def record field anchored"><a href="#type-basic_state.max_scope_id" class="anchor"></a><code><span>max_scope_id : int;</span></code></li><li id="type-basic_state.expanded_scopes" class="def record field anchored"><a href="#type-basic_state.expanded_scopes" class="anchor"></a><code><span>expanded_scopes : <span>int list</span>;</span></code></li><li id="type-basic_state.unfolded_ellipsis" class="def record field anchored"><a href="#type-basic_state.unfolded_ellipsis" class="anchor"></a><code><span>unfolded_ellipsis : <a href="../Interactive/EllipsisSet/index.html#type-t">I.EllipsisSet.t</a>;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>Read basic TUI state (without reconstructing full view_state)</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-read_basic_state"><a href="#val-read_basic_state" class="anchor"></a><code><span><span class="keyword">val</span> read_basic_state : <span><a href="#type-tui_db">tui_db</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-basic_state">basic_state</a> option</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-read_visible_items"><a href="#val-read_visible_items" class="anchor"></a><code><span><span class="keyword">val</span> read_visible_items : <span><a href="#type-tui_db">tui_db</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span class="keyword">module</span> <a href="../Query/module-type-S/index.html">Q.S</a>)</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Interactive/index.html#type-visible_item">I.visible_item</a> array</span></span></code></div><div class="spec-doc"><p>Read visible items from database</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-search_slot_info"><a href="#type-search_slot_info" class="anchor"></a><code><span><span class="keyword">type</span> search_slot_info</span><span> = </span><span>{</span></code><ol><li id="type-search_slot_info.slot_number" class="def record field anchored"><a href="#type-search_slot_info.slot_number" class="anchor"></a><code><span>slot_number : <a href="../Interactive/SlotNumber/index.html#type-t">I.SlotNumber.t</a>;</span></code></li><li id="type-search_slot_info.search_type" class="def record field anchored"><a href="#type-search_slot_info.search_type" class="anchor"></a><code><span>search_type : string;</span></code></li><li id="type-search_slot_info.search_term" class="def record field anchored"><a href="#type-search_slot_info.search_term" class="anchor"></a><code><span>search_term : <span>string option</span>;</span></code></li><li id="type-search_slot_info.display_text" class="def record field anchored"><a href="#type-search_slot_info.display_text" class="anchor"></a><code><span>display_text : <span>string option</span>;</span></code></li><li id="type-search_slot_info.completed" class="def record field anchored"><a href="#type-search_slot_info.completed" class="anchor"></a><code><span>completed : bool;</span></code></li><li id="type-search_slot_info.result_count" class="def record field anchored"><a href="#type-search_slot_info.result_count" class="anchor"></a><code><span>result_count : int;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>Read search slots metadata</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-read_search_slots"><a href="#val-read_search_slots" class="anchor"></a><code><span><span class="keyword">val</span> read_search_slots : <span><a href="#type-tui_db">tui_db</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-search_slot_info">search_slot_info</a> list</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-read_snapshot"><a href="#val-read_snapshot" class="anchor"></a><code><span><span class="keyword">val</span> read_snapshot : 
  <span><a href="#type-tui_db">tui_db</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span class="keyword">module</span> <a href="../Query/module-type-S/index.html">Q.S</a>)</span> <span class="arrow">&#45;&gt;</span></span>
  int * <span><a href="#type-basic_state">basic_state</a> option</span> * <span><a href="../Interactive/index.html#type-visible_item">I.visible_item</a> array</span> * <span><a href="#type-search_slot_info">search_slot_info</a> list</span></span></code></div><div class="spec-doc"><p>Consistent snapshot read: reads all state under a single transaction. Returns (revision, basic_state option, visible_items, search_slots). Uses read-committed isolation - the transaction ensures all reads see the same snapshot.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-insert_command"><a href="#val-insert_command" class="anchor"></a><code><span><span class="keyword">val</span> insert_command : 
  <span><a href="#type-tui_db">tui_db</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">client_id</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?batch_id</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span><span>(int, string)</span> <span class="xref-unresolved">Stdlib</span>.result</span></span></code></div><div class="spec-doc"><p>Insert a command into the queue</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-pending_command"><a href="#type-pending_command" class="anchor"></a><code><span><span class="keyword">type</span> pending_command</span><span> = </span><span>{</span></code><ol><li id="type-pending_command.cmd_id" class="def record field anchored"><a href="#type-pending_command.cmd_id" class="anchor"></a><code><span>cmd_id : int;</span></code></li><li id="type-pending_command.client_id" class="def record field anchored"><a href="#type-pending_command.client_id" class="anchor"></a><code><span>client_id : string;</span></code></li><li id="type-pending_command.batch_id" class="def record field anchored"><a href="#type-pending_command.batch_id" class="anchor"></a><code><span>batch_id : <span>string option</span>;</span></code></li><li id="type-pending_command.command" class="def record field anchored"><a href="#type-pending_command.command" class="anchor"></a><code><span>command : string;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>Poll for pending commands</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-poll_pending_commands"><a href="#val-poll_pending_commands" class="anchor"></a><code><span><span class="keyword">val</span> poll_pending_commands : <span><a href="#type-tui_db">tui_db</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-pending_command">pending_command</a> list</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-mark_command_processing"><a href="#val-mark_command_processing" class="anchor"></a><code><span><span class="keyword">val</span> mark_command_processing : <span><a href="#type-tui_db">tui_db</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Mark a command as processing</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-mark_command_done"><a href="#val-mark_command_done" class="anchor"></a><code><span><span class="keyword">val</span> mark_command_done : <span><a href="#type-tui_db">tui_db</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Mark a command as done</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-mark_command_error"><a href="#val-mark_command_error" class="anchor"></a><code><span><span class="keyword">val</span> mark_command_error : <span><a href="#type-tui_db">tui_db</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Mark a command as error</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-is_batch_complete"><a href="#val-is_batch_complete" class="anchor"></a><code><span><span class="keyword">val</span> is_batch_complete : <span><a href="#type-tui_db">tui_db</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p>Check if a batch is complete. A batch is complete when no commands are 'pending' or 'processing'. Also verifies batch actually exists to avoid false positives on empty/unknown batches.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_batch_errors"><a href="#val-get_batch_errors" class="anchor"></a><code><span><span class="keyword">val</span> get_batch_errors : <span><a href="#type-tui_db">tui_db</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span><span>(string * string)</span> list</span></span></code></div><div class="spec-doc"><p>Get batch errors</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-wait_for_batch"><a href="#val-wait_for_batch" class="anchor"></a><code><span><span class="keyword">val</span> wait_for_batch : 
  <span><a href="#type-tui_db">tui_db</a> <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">timeout_sec</span>:float <span class="arrow">&#45;&gt;</span></span>
  <span><span>(unit, string)</span> <span class="xref-unresolved">Stdlib</span>.result</span></span></code></div><div class="spec-doc"><p>Wait for batch completion with timeout</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-make_db_callbacks"><a href="#val-make_db_callbacks" class="anchor"></a><code><span><span class="keyword">val</span> make_db_callbacks : <span><a href="#type-tui_db">tui_db</a> <span class="arrow">&#45;&gt;</span></span> <a href="../Interactive/index.html#type-db_callbacks">I.db_callbacks</a></span></code></div><div class="spec-doc"><p>Create db_callbacks for Interactive.run_with_db. Converts Tui_db pending_command to Interactive.pending_command. Uses persist_state_atomic for atomic snapshot writes.</p></div></div></div></body></html>
